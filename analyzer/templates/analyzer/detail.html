{% extends "analyzer/base.html" %}
{% load custom_tags %}

{% block content %}
<h1 class="display-4">Analysis results for: {{ dataset.name }}</h1>


<!-- Basic info -->
<div class="card mt-4 mb-3 text-dark">
    <div class="card-header bg-secondary text-white">Basic information</div>
    <div class="card-body">
        <ul class="list-unstyled mb-0">
            <li><strong>ID:</strong> {{ dataset.id }}</li>
            <li><strong>File name:</strong> {{ dataset.name }}</li>
            <li><strong>Number of rows:</strong> {{ analysis.rows }}</li>
            <li><strong>Number of columns:</strong> {{ analysis.columns }}</li>
        </ul>
    </div>
</div>


<!-- Column names -->
<div class="card mb-3 text-dark">
    <div class="card-header bg-secondary text-white">Column names</div>
    <div class="card-body">
        <ul>
            {% for col in analysis.column_names %}
            <li>{{ col }}</li>
            {% endfor %}
        </ul>
    </div>
</div>


<!-- Averages -->
<div class="card mb-3">
    <div class="card-header bg-secondary text-white">Average numerical values</div>
    <div class="card-body">
        <table class="table table-dark table-striped table-bordered">
            <thead>
                <tr>
                    <th>Column</th>
                    <th>Average</th>
                </tr>
            </thead>
            <tbody>
                {% for col, mean in analysis.numeric_means.items %}
                <tr>
                    <td>{{ col }}</td>
                    <td>{{ mean|floatformat:3 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<!-- Linear regression -->
<div class="card mb-3">
    <div class="card-header bg-secondary text-white">Linear Regression</div>
    <div class="card-body">
        {% if regression %}
        <ul class="list unstyled mb-0">
            <li><strong>Regression coefficients:</strong> {{ regression.coefficients }}</li>
            <li><strong>Intercept:</strong> {{ regression.intercept|floatformat:3 }}</li>
            <li><strong>RÂ²:</strong> {{ regression.r2_score|floatformat:3 }}</li>
        </ul>
        {% if regression_plot %}
            <img src="data:image/png;base64,{{ regression_plot }}" class="img-fluid" alt="Regression plot">
        {% endif %}
        {% else %}
            <p>No regression available.</p>
        {% endif %}
    </div>
</div>


<!-- Data preview -->
<div class="card mb-3">
    <div class="card-header bg-secondary text-white">Data preview (first 5 rows)</div>
    <div class="card-body table-responsive">
        {{ preview_html|safe }}
    </div>
</div>


<!-- ML models -->
{% if ml_results %}
    {% for model_name, model_data in ml_results.items %}
        {% if model_data %}
        <div class="card mb-3">
            <div class="card-header bg-secondary text-white">{{ model_name|title }} Classification</div>
            <div class="card-body">
                <p><strong>Accuracy:</strong> {{ model_data.accuracy|floatformat:3 }}</p>
                <div class="table-responsive">
                    <table class="table table-dark table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Precision</th>
                                <th>Recall</th>
                                <th>F1-score</th>
                                <th>Support</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cls, metrics in model_data.report.items %}
                                {% if cls != 'accuracy' and cls != 'macro avg' and cls != 'weighted avg' %}
                                <tr>
                                    <td>{{ cls }}</td>
                                    <td>{{ metrics.precision|floatformat:3 }}</td>
                                    <td>{{ metrics.recall|floatformat:3 }}</td>
                                    <td>{{ metrics|get_item:"f1-score"|floatformat:3 }}</td>
                                    <td>{{ metrics.support }}</td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- ML Visualization -->
                {% if model_data.plots %}
                <div class="row mt-3">
                    <!-- Confusion matrix -->
                    {% if model_data.plots.confusion_matrix %}
                    <div class="col-md-3 text-center mb-3">
                        <h6>Confusion Matrix</h6>
                        <img src="data:image/png;base64,{{ model_data.plots.confusion_matrix }}" class="img-fluid">
                    </div>
                    {% endif %}

                    <!-- Feature importances -->
                    {% if model_data.plots.feature_importances %}
                    <div class="col-md-3 text-center mb-3">
                        <h6>Feature Importances</h6>
                        <img src="data:image/png;base64,{{ model_data.plots.feature_importances }}" class="img-fluid">
                    </div>
                    {% endif %}

                    <!-- Prediction distribution -->
                    {% if model_data.plots.prediction_dist %}
                    <div class="col-md-3 text-center mb-3">
                        <h6>Prediction Distribution</h6>
                        <img src="data:image/png;base64,{{ model_data.plots.prediction_dist }}" class="img-fluid">
                    </div>
                    {% endif %}

                    <!-- ROC curve -->
                    {% if model_data.plots.roc_curve %}
                    <div class="col-md-3 text-center mb-3">
                        <h6>ROC curve</h6>
                        <img src="data:image/png;base64,{{ model_data.plots.roc_curve }}" class="img-fluid">
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    {% endfor %}
{% endif %}

<a href="{% url 'upload_dataset' %}" class="btn btn-primary mt-3">Upload new file</a>
{% endblock %}